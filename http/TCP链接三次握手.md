## 建立连接三次握手

`TCP`三次握手是指一个`TCP连接建立需要经历三次通信分别是
1. 初始 客户端 `CLOSED` 服务器`CLOSED`。
2. 客户端主动打开连接，服务器被动打开连接。
3. 服务器进入`LISTEN`状态。
4. 客户端发送`SYN= 1, seq = x` 客户端进入`SYN-SENT`状态。
5. 服务端接收到`SYN` 返回`SYN = 1, ACK = 1, seq = y, ack= x + 1` 进入`SYN-RCVD`状态。
6. 客户端再次发送`ACK = 1, seq = x + 1, ack = y + 1` 进入 `ESTAB-LISHED` 状态。
7. 服务端接收到`ACK` 服务端进入`ESTAB-LISHED`。
8. 连接建立。

### 为什么要三次握手

主要是为了防止已失效的报文连接突然又传送给`客户端`, 将设`客户端`发送`SYN`请求连接，但是由于网络延迟这个请求在某个网络请求节点长时间滞留, `客户端`由于没有在规定时间内收到`ACK`, 就会再次发送`SYN`, 假设第二次是正常建立连接并发送完数据关闭了连接。此时服务器收到第一次`SYN`便返回`ACK`， 如果只需要两次握手那么客户端只要收到`ACK`就建立连接，这就会造成资源浪费。因为实际上这次连接是不必要的。
三次握手就能避免这种问题， 由于客户端知道自己并没有发送建立连接的请求所以并不会发起第三次握手。

## 断开连接四次挥手

1. 初始客户端和服务器都是`ESTAB-LISHED`状态。
2. 客户端发送断开连接请求`FIN = 1, seq = u` 进入`FIN-WAIT-1`状态 `u` 为已传送数据序号加1。
3. 服务端返回`ACK = 1, seq = v, ack = u+1` 进入`CLOSE-WAIT`。
4. 客户端 进入`FIN-WAIT-2` 此时连接处于半关闭状态 客户端已经无数据发送，但是服务端发送数据客户端仍要接收这个很好理解由于是客户端主动发起的关闭请求所以客户端一定是没有数据发送了。
5. 服务端发送`FIN = 1, ACK = 1, seq = w, ack = u + 1` 进入 `LAST-ACK` 此时服务端的数据也发送完毕了。
6. 客户端发送`ACK = 1, seq = u + 1, ack = w + 1` 确认关闭。
7. 服务端 `CLOSED`。
8. 客户端等待`2MSL` `MSL`最长报文段寿命。
9. 客户端`CLOSED`

### 为什么要等待`2MSL` 

1. 为了保证客户端发送的最后一个`ACK`报文服务端能够收到, 假设最后一个`ACK`报文丢失了， 服务端就会再次发送上一步的`FIN + ACK`报文， 所以如果客户端不等待就`CLOSED`掉， 如果遇到这种情况服务端就无法正常关闭了。
2. 防止`已失效的请求报文段`出现在本次连接中。


